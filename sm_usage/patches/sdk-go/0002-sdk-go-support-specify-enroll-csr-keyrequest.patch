From 5ef8a687da637a034219d504c6465c403f7ceeaa Mon Sep 17 00:00:00 2001
From: fengjianjian <fengjj@7zhilu.com>
Date: Thu, 3 Jan 2019 08:54:07 +0800
Subject: [PATCH 2/3] sdk-go support specify enroll csr keyrequest

---
 pkg/msp/api/api.go      | 14 +++++++++++---
 pkg/msp/fabcaadapter.go | 38 +++++++++++++++++++++++++-------------
 2 files changed, 36 insertions(+), 16 deletions(-)

diff --git a/pkg/msp/api/api.go b/pkg/msp/api/api.go
index eded1441..6183f7a3 100644
--- a/pkg/msp/api/api.go
+++ b/pkg/msp/api/api.go
@@ -77,6 +77,16 @@ type EnrollmentRequest struct {
 	// The type of the enrollment request: x509 or idemix
 	// The default is a request for an X509 enrollment certificate
 	Type string
+	CSR  *CSRRequest
+}
+
+type CSRRequest struct {
+	KeyRequest *KeyRequest
+}
+
+type KeyRequest struct {
+	Algorithm string
+	Size      int
 }
 
 // ReenrollmentRequest is a request to reenroll an identity.
@@ -91,6 +101,7 @@ type ReenrollmentRequest struct {
 	// AttrReqs are requests for attributes to add to the certificate.
 	// Each attribute is added only if the requestor owns the attribute.
 	AttrReqs []*AttributeRequest
+	CSR  *CSRRequest
 }
 
 // Attribute defines additional attributes that may be passed along during registration
@@ -135,7 +146,6 @@ type RevokedCert struct {
 
 // IdentityRequest represents the request to add/update identity to the fabric-ca-server
 type IdentityRequest struct {
-
 	// The enrollment ID which uniquely identifies an identity (required)
 	ID string
 
@@ -161,7 +171,6 @@ type IdentityRequest struct {
 // RemoveIdentityRequest represents the request to remove an existing identity from the
 // fabric-ca-server
 type RemoveIdentityRequest struct {
-
 	// The enrollment ID which uniquely identifies an identity
 	ID string
 
@@ -174,7 +183,6 @@ type RemoveIdentityRequest struct {
 
 // IdentityResponse is the response from the any read/add/modify/remove identity call
 type IdentityResponse struct {
-
 	// The enrollment ID which uniquely identifies an identity
 	ID string
 
diff --git a/pkg/msp/fabcaadapter.go b/pkg/msp/fabcaadapter.go
index d7ff1406..d55bd882 100644
--- a/pkg/msp/fabcaadapter.go
+++ b/pkg/msp/fabcaadapter.go
@@ -57,6 +57,12 @@ func (c *fabricCAAdapter) Enroll(request *api.EnrollmentRequest) ([]byte, error)
 		Type:    request.Type,
 		Label:   request.Label,
 	}
+	if request.CSR != nil && request.CSR.KeyRequest != nil {
+		careq.CSR = new(caapi.CSRInfo)
+		careq.CSR.KeyRequest = new(caapi.BasicKeyRequest)
+		careq.CSR.KeyRequest.Algo = request.CSR.KeyRequest.Algorithm
+		careq.CSR.KeyRequest.Size = request.CSR.KeyRequest.Size
+	}
 
 	if len(request.AttrReqs) > 0 {
 		attrs := make([]*caapi.AttributeRequest, len(request.AttrReqs))
@@ -83,6 +89,12 @@ func (c *fabricCAAdapter) Reenroll(key core.Key, cert []byte, request *api.Reenr
 		Profile: request.Profile,
 		Label:   request.Label,
 	}
+	if request.CSR != nil && request.CSR.KeyRequest != nil {
+		careq.CSR = new(caapi.CSRInfo)
+		careq.CSR.KeyRequest = new(caapi.BasicKeyRequest)
+		careq.CSR.KeyRequest.Algo = request.CSR.KeyRequest.Algorithm
+		careq.CSR.KeyRequest.Size = request.CSR.KeyRequest.Size
+	}
 	if len(request.AttrReqs) > 0 {
 		attrs := make([]*caapi.AttributeRequest, len(request.AttrReqs))
 		for i, a := range request.AttrReqs {
@@ -306,12 +318,12 @@ func getIdentityResponse(response *caapi.IdentityResponse) *api.IdentityResponse
 	}
 
 	ret := &api.IdentityResponse{ID: response.ID,
-		Affiliation:    response.Affiliation,
-		Type:           response.Type,
-		Attributes:     attributes,
+		Affiliation: response.Affiliation,
+		Type: response.Type,
+		Attributes: attributes,
 		MaxEnrollments: response.MaxEnrollments,
-		Secret:         response.Secret,
-		CAName:         response.CAName,
+		Secret: response.Secret,
+		CAName: response.CAName,
 	}
 
 	return ret
@@ -341,11 +353,11 @@ func (c *fabricCAAdapter) GetIdentity(key core.Key, cert []byte, id, caname stri
 	}
 
 	ret := &api.IdentityResponse{ID: response.ID,
-		Affiliation:    response.Affiliation,
-		Type:           response.Type,
-		Attributes:     attributes,
+		Affiliation: response.Affiliation,
+		Type: response.Type,
+		Attributes: attributes,
 		MaxEnrollments: response.MaxEnrollments,
-		CAName:         response.CAName,
+		CAName: response.CAName,
 	}
 
 	return ret, nil
@@ -566,11 +578,11 @@ func getIdentityResponses(ca string, responses []caapi.IdentityInfo) []*api.Iden
 			attributes = append(attributes, api.Attribute{Name: response.Attributes[i].Name, Value: response.Attributes[i].Value, ECert: response.Attributes[i].ECert})
 		}
 		ret[j] = &api.IdentityResponse{ID: response.ID,
-			Affiliation:    response.Affiliation,
-			Type:           response.Type,
-			Attributes:     attributes,
+			Affiliation: response.Affiliation,
+			Type: response.Type,
+			Attributes: attributes,
 			MaxEnrollments: response.MaxEnrollments,
-			CAName:         ca,
+			CAName: ca,
 		}
 	}
 
-- 
2.20.1.windows.1


From 33fc98148662336c8812ef5251bc1b8aeac21210 Mon Sep 17 00:00:00 2001
From: fengjianjian <fengjj@7zhilu.com>
Date: Fri, 14 Feb 2020 19:01:11 +0800
Subject: [PATCH] =?UTF-8?q?=E5=A2=9E=E5=8A=A0rsa=E6=94=AF=E6=8C=81?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 .gitignore                                         |  1 +
 util/csp.go                                        | 11 +++++++++-
 vendor/github.com/hyperledger/fabric/bccsp/opts.go | 15 +++++++++++++
 .../hyperledger/fabric/bccsp/sw/keyimport.go       | 25 ++++++++++++++++++++++
 .../github.com/hyperledger/fabric/bccsp/sw/new.go  |  1 +
 .../github.com/hyperledger/fabric/bccsp/sw/rsa.go  |  6 +++---
 .../hyperledger/fabric/bccsp/utils/keys.go         |  7 ++++++
 7 files changed, 62 insertions(+), 4 deletions(-)

diff --git a/.gitignore b/.gitignore
index 87f85eb..8afa303 100644
--- a/.gitignore
+++ b/.gitignore
@@ -21,3 +21,4 @@ testdata/ec_cert.pem
 vendor/github.com/cloudflare/cfssl/vendor/github.com/cloudflare/cfssl_trust/ca-bundle/http:*.crt
 # tox
 .tox/
+.idea/
\ No newline at end of file
diff --git a/util/csp.go b/util/csp.go
index 7c566f6..625b4bd 100644
--- a/util/csp.go
+++ b/util/csp.go
@@ -238,7 +238,16 @@ func ImportBCCSPKeyFromPEM(keyFile string, myCSP bccsp.BCCSP, temporary bool) (b
 		}
 		return sk, nil
 	case *rsa.PrivateKey:
-		return nil, errors.Errorf("Failed to import RSA key from %s; RSA private key import is not supported", keyFile)
+		priv, err := utils.RsaPrivateKeyToDER(key.(*rsa.PrivateKey))
+		if err != nil {
+			return nil, errors.WithMessage(err, fmt.Sprintf("Failed to convert rsa private key for '%s'", keyFile))
+		}
+		sk, err := myCSP.KeyImport(priv, &bccsp.RSA2048PrivateKeyImportOpts{Temporary: temporary})
+		if err != nil {
+			return nil, errors.WithMessage(err, fmt.Sprintf("Failed to import rsa private key for '%s'", keyFile))
+		}
+		return sk, nil
+		//return nil, errors.Errorf("Failed to import RSA key from %s; RSA private key import is not supported", keyFile)
 	default:
 		return nil, errors.Errorf("Failed to import key from %s: invalid secret key type", keyFile)
 	}
diff --git a/vendor/github.com/hyperledger/fabric/bccsp/opts.go b/vendor/github.com/hyperledger/fabric/bccsp/opts.go
index 5a0560d..266e978 100644
--- a/vendor/github.com/hyperledger/fabric/bccsp/opts.go
+++ b/vendor/github.com/hyperledger/fabric/bccsp/opts.go
@@ -304,6 +304,21 @@ func (opts *RSAGoPublicKeyImportOpts) Algorithm() string {
 func (opts *RSAGoPublicKeyImportOpts) Ephemeral() bool {
 	return opts.Temporary
 }
+// RSA2048PrivateKeyImportOpts contains options for RSA2048 secret key importation in DER format
+type RSA2048PrivateKeyImportOpts struct {
+	Temporary bool
+}
+
+// Algorithm returns the key importation algorithm identifier (to be used).
+func (opts *RSA2048PrivateKeyImportOpts) Algorithm() string {
+	return RSA2048
+}
+
+// Ephemeral returns true if the key to generate has to be ephemeral,
+// false otherwise.
+func (opts *RSA2048PrivateKeyImportOpts) Ephemeral() bool {
+	return opts.Temporary
+}
 
 // X509PublicKeyImportOpts contains options for importing public keys from an x509 certificate
 type X509PublicKeyImportOpts struct {
diff --git a/vendor/github.com/hyperledger/fabric/bccsp/sw/keyimport.go b/vendor/github.com/hyperledger/fabric/bccsp/sw/keyimport.go
index b2003fb..e518381 100644
--- a/vendor/github.com/hyperledger/fabric/bccsp/sw/keyimport.go
+++ b/vendor/github.com/hyperledger/fabric/bccsp/sw/keyimport.go
@@ -134,6 +134,31 @@ func (*rsaGoPublicKeyImportOptsKeyImporter) KeyImport(raw interface{}, opts bccs
 	return &rsaPublicKey{lowLevelKey}, nil
 }
 
+type rsaPrivatekeyImportOptsKeyImporter struct {
+}
+
+func (*rsaPrivatekeyImportOptsKeyImporter) KeyImport(raw interface{}, opts bccsp.KeyImportOpts) (bccsp.Key, error) {
+	der, ok := raw.([]byte)
+	if !ok {
+		return nil, errors.New("[RSA2048PrivateKeyImportOpts] Invalid raw material. Expected byte array.")
+	}
+
+	if len(der) == 0 {
+		return nil, errors.New("[RSA2048PrivateKeyImportOpts] Invalid raw. It must not be nil.")
+	}
+
+	lowLevelKey, err := utils.DERToPrivateKey(der)
+	if err != nil {
+		return nil, fmt.Errorf("Failed converting PKIX to rsa public key [%s]", err)
+	}
+
+	rsaSK, ok := lowLevelKey.(*rsa.PrivateKey)
+	if !ok {
+		return nil, errors.New("Failed casting to rsa private key. Invalid raw material.")
+	}
+	return &rsaPrivateKey{rsaSK}, nil
+}
+
 type x509PublicKeyImportOptsKeyImporter struct {
 	bccsp *CSP
 }
diff --git a/vendor/github.com/hyperledger/fabric/bccsp/sw/new.go b/vendor/github.com/hyperledger/fabric/bccsp/sw/new.go
index 26366d1..313556a 100644
--- a/vendor/github.com/hyperledger/fabric/bccsp/sw/new.go
+++ b/vendor/github.com/hyperledger/fabric/bccsp/sw/new.go
@@ -101,6 +101,7 @@ func NewWithParams(securityLevel int, hashFamily string, keyStore bccsp.KeyStore
 	swbccsp.AddWrapper(reflect.TypeOf(&bccsp.ECDSAGoPublicKeyImportOpts{}), &ecdsaGoPublicKeyImportOptsKeyImporter{})
 	swbccsp.AddWrapper(reflect.TypeOf(&bccsp.RSAGoPublicKeyImportOpts{}), &rsaGoPublicKeyImportOptsKeyImporter{})
 	swbccsp.AddWrapper(reflect.TypeOf(&bccsp.X509PublicKeyImportOpts{}), &x509PublicKeyImportOptsKeyImporter{bccsp: swbccsp})
+	swbccsp.AddWrapper(reflect.TypeOf(&bccsp.RSA2048PrivateKeyImportOpts{}), &rsaPrivatekeyImportOptsKeyImporter{})
 
 	return swbccsp, nil
 }
diff --git a/vendor/github.com/hyperledger/fabric/bccsp/sw/rsa.go b/vendor/github.com/hyperledger/fabric/bccsp/sw/rsa.go
index 375990d..b2cc184 100644
--- a/vendor/github.com/hyperledger/fabric/bccsp/sw/rsa.go
+++ b/vendor/github.com/hyperledger/fabric/bccsp/sw/rsa.go
@@ -29,7 +29,7 @@ type rsaSigner struct{}
 
 func (s *rsaSigner) Sign(k bccsp.Key, digest []byte, opts bccsp.SignerOpts) ([]byte, error) {
 	if opts == nil {
-		return nil, errors.New("Invalid options. Must be different from nil.")
+		opts = &rsa.PSSOptions{SaltLength: rsa.PSSSaltLengthEqualsHash, Hash: crypto.SHA256}
 	}
 
 	return k.(*rsaPrivateKey).privKey.Sign(rand.Reader, digest, opts)
@@ -39,7 +39,7 @@ type rsaPrivateKeyVerifier struct{}
 
 func (v *rsaPrivateKeyVerifier) Verify(k bccsp.Key, signature, digest []byte, opts bccsp.SignerOpts) (bool, error) {
 	if opts == nil {
-		return false, errors.New("Invalid options. It must not be nil.")
+		opts = &rsa.PSSOptions{SaltLength: rsa.PSSSaltLengthEqualsHash, Hash: crypto.SHA256}
 	}
 	switch opts.(type) {
 	case *rsa.PSSOptions:
@@ -57,7 +57,7 @@ type rsaPublicKeyKeyVerifier struct{}
 
 func (v *rsaPublicKeyKeyVerifier) Verify(k bccsp.Key, signature, digest []byte, opts bccsp.SignerOpts) (bool, error) {
 	if opts == nil {
-		return false, errors.New("Invalid options. It must not be nil.")
+		opts = &rsa.PSSOptions{SaltLength: rsa.PSSSaltLengthEqualsHash, Hash: crypto.SHA256}
 	}
 	switch opts.(type) {
 	case *rsa.PSSOptions:
diff --git a/vendor/github.com/hyperledger/fabric/bccsp/utils/keys.go b/vendor/github.com/hyperledger/fabric/bccsp/utils/keys.go
index ee2d928..428e227 100644
--- a/vendor/github.com/hyperledger/fabric/bccsp/utils/keys.go
+++ b/vendor/github.com/hyperledger/fabric/bccsp/utils/keys.go
@@ -74,6 +74,13 @@ func PrivateKeyToDER(privateKey *ecdsa.PrivateKey) ([]byte, error) {
 	return x509.MarshalECPrivateKey(privateKey)
 }
 
+func RsaPrivateKeyToDER(privateKey *rsa.PrivateKey) ([]byte, error) {
+	if privateKey == nil {
+		return nil, errors.New("Invalid rsa private key. It must be different from nil.")
+	}
+	return x509.MarshalPKCS1PrivateKey(privateKey), nil
+}
+
 // PrivateKeyToPEM converts the private key to PEM format.
 // EC private keys are converted to PKCS#8 format.
 // RSA private keys are converted to PKCS#1 format.
-- 
2.7.4

